
    
WITH PRODUCT_CHURNED_FOR_LAST_ONE_MONTH AS (
    SELECT
        CUSTOMER_ID,
        COUNT(DISTINCT PRODUCT_ID) AS TOTAL_PROD,
        COUNT(DISTINCT CASE WHEN PAYMENT_MONTH > DATEADD(month, -1, '2020-06-01') THEN PRODUCT_ID END) AS LAST_PROD
    FROM
        PROJECT.staging.stg_transactions
    GROUP BY
        CUSTOMER_ID
)
SELECT
    CUSTOMER_ID,
    TOTAL_PROD AS CROSS_SELL,
    LAST_PROD,
    (TOTAL_PROD- LAST_PROD) AS CHURNED_PRODUCTS,
FROM
   PRODUCT_CHURNED_FOR_LAST_ONE_MONTH